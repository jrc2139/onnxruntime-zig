name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  ZIG_VERSION: "0.15.2"
  ORT_VERSION: "1.23.2"
  PYTHON_VERSION: "3.12"

jobs:
  test:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            ort_platform: linux-x64
            zig_platform: linux-x86_64
          - os: macos-14 # Apple Silicon runner
            ort_platform: osx-arm64
            zig_platform: macos-aarch64

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Download ONNX Runtime
        run: |
          mkdir -p deps/onnxruntime
          curl -L "https://github.com/microsoft/onnxruntime/releases/download/v${{ env.ORT_VERSION }}/onnxruntime-${{ matrix.ort_platform }}-${{ env.ORT_VERSION }}.tgz" \
            | tar -xz --strip-components=1 -C deps/onnxruntime

      - name: Verify ONNX Runtime
        run: |
          ls -la deps/onnxruntime/
          ls -la deps/onnxruntime/include/
          ls -la deps/onnxruntime/lib/

      - name: Build
        run: zig build

      - name: Run Tests
        run: zig build test

      - name: Check compilation
        run: zig build check

  # Run examples with a test model for end-to-end verification
  examples:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            ort_platform: linux-x64
          - os: macos-14
            ort_platform: osx-arm64

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Download ONNX Runtime
        run: |
          mkdir -p deps/onnxruntime
          curl -L "https://github.com/microsoft/onnxruntime/releases/download/v${{ env.ORT_VERSION }}/onnxruntime-${{ matrix.ort_platform }}-${{ env.ORT_VERSION }}.tgz" \
            | tar -xz --strip-components=1 -C deps/onnxruntime

      - name: Create test model
        run: |
          uvx --with onnx --with numpy python3 -c "
          import numpy as np
          import onnx
          from onnx import helper, TensorProto, numpy_helper

          # Simple model: output = input * 2
          X = helper.make_tensor_value_info('X', TensorProto.FLOAT, [1, 4])
          Y = helper.make_tensor_value_info('Y', TensorProto.FLOAT, [1, 4])
          two = numpy_helper.from_array(np.array([2.0], dtype=np.float32), name='two')
          mul_node = helper.make_node('Mul', ['X', 'two'], ['Y'])
          graph = helper.make_graph([mul_node], 'mul_graph', [X], [Y], [two])
          model = helper.make_model(graph, opset_imports=[helper.make_opsetid('', 18)])
          model.ir_version = 8
          onnx.save(model, 'test_model.onnx')
          onnx.checker.check_model(model)
          print('Created test_model.onnx')
          "

      - name: Build all examples
        run: |
          zig build
          ls -la zig-out/bin/

      - name: Run basic inference example
        run: zig build run -- test_model.onnx

      - name: Run zero-alloc inference example
        run: zig build run-zero-alloc -- test_model.onnx

      - name: Run async inference example
        run: zig build run-async -- test_model.onnx

      - name: Run benchmark
        run: zig build run-benchmark -- test_model.onnx

  format:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Check formatting
        run: zig fmt --check src/ examples/
